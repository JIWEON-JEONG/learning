# Settlement System

## 배경 
- 데이터 무결성 및 추적가능성을 보완한 정산시스템의 요구사항이 존재하였다.  

데이터 무결성이 깨지는 시나리오 정의

1. 데이터베이스 임의 조작 
- 내부 직원의 데이터 임의 조작 
- 루트 계정으로 데이터 임의 조작 

2. 로직으로 인한 데이터 무결성 훼손 

3. 서버 에러로 인한 데이터 무결성 훼손

## 해결 

### 내부 직원의 데이터 임의 조작
- CS 혹은 QA 등 내부직원들에게 제공하는 데이터베이스 계정 ReadOnly Role 적용.

### 루트 계정으로 데이터 임의 조작
- 감사로그 (Audit_Log)를 통한 원장 데이터에 UPDATE, DELETE 이벤트 발생 시 경고 메일 전송.
- VPC 외의 IP 에서 원장테이블 접근 시 Lambda 함수를 통한 경고 메일 전송 가능.

### 로직으로 인한 데이터 무결성 훼손
- 정책 기반의 단위테스트. (세금 계산의 경우 내림처리, 수업료, 보너스 등)
- 시나리오 기반 QA.

### 서버 에러로 인한 데이터 무결성 훼손
- 정산혹은 재화 관련 작업과 그외의 작업을 비동기 처리를 통해 결합도 최소화.

### 추적 가능성 
- 원장 거래내역 테이블에 내역에 대한 참조 데이터를 JSON 형식으로 저장.
- 참조 데이터를 기반으로 역추적 할 수 있도록 설계.

## 성능 문제 
정산 내역과 함께 내역이 어떤 수업으로 쌓였는지, 수업에는 어떤 학생들이 듣는 수업인지, 어떤 과목의 수업인지 등에 대한 정보도 함께 
노출해줘야하는 요구사항이 존재하였다. 

해당 요구사항을 처리하는 API 에서 p90 기준 1s 가 넘는 문제가 발생하였다. 
이에 대한 원인은, 각 정산 내역과 연결된 정보를 가져오는 과정에서 N+1 문제가 발생한 것이다.

## 성능 문제 해결 
이를 해결하기 위해 조회테이블 분리 방법을 선택하였다. 
쿼리에 대한 조회를 Bulk 로 처리하는 방법도 있었지만, 페이지에서 보여줘야되는 데이터들이 변경될 수 있다는 부분에서 확장성이 떨어진다고 생각하였다.

User 서버에서는 MongoDB 를 히스토리 데이터, 지원서 데이터 등 이미 사용중이였기 때문에, 조회에 필요한 데이터를 하나의 스키마에 넣어두어 이를 해결하였다.

이렇게 분리된 데이터는 이중화가 되게 되어, 가정산 시 데이터 무결성 검증에도 활용 할 수 있다는 생각이 들었다.  

데이터에서 대한 Sync 는 정산이나 재화관련 작업의 트랜잭션이 모두 끝난후, 비동기 이벤트를 통해 데이터 싱크를 맞춰주는 Flow 로 작업하였다.

이를 통해 300ms 로 성능개선을 할 수 있었다.

또한 데이터 조회시, 클라이언트에서 사용하지 않는 필드들이 많이 존재하게 되어 (version, 누적포인트 등) 조회에 필요한 경량화 된 DTO 를
정의하여 불필요한 I/O 와 매핑 리소스를 제거하였다.

## Tables

- Wallet 
- SettlementConfig
- Financial Transaction
- Done Month


