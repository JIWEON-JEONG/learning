# Schema Registry

## 배경 
Kafka 스키마의 변화에 따른 문제를 해결하기위해 나오게 되었다. 

1. 데이터 호환성 문제 
- 프로듀서가 스키마를 수정하였을때, 컨슈머가 필드를 인식하지 못해 파싱 오류 발생.
2. 스키마 관리의 어려움
- 스키마를 프로듀서, 컨슈머s 들 모두 분산하여 관리해야하기 때문에 일관성 문제 발생.

## 해결 
스키마의 중앙집중식 관리를 통해 문제를 해결한다. 

1. 카프카에 메시지를 보내기 전에, Producer 는 Schema Registry 에 본인의 스키마를 등록한다. 고유한 ID를 통해 관리.
2. 프로듀서는 실제 메시지 페이로드와 함께 스키마 ID를 함께 보낸다.
3. 스키마 ID 를 통해 컨슈머에서는 스키마를 가지고 와, 해당 스키마를 역직렬화 하여 사용한다. (컨슈머 측에서는 스키마 관리 X)
4. 호환성 옵션을 통해 세부 설정을 한다. 
    - BACKWARD : 필드 변경이나 삭제를 막아, 하위 호환성을 보장한다.
    - FORWARD : 오래된 프로듀서가 새로운 컨슈머의 호환성을 지킬 수 있도록, default 값 전송.

## 경험 
A 서비스를 확장 (리뉴얼)한 B 서비스를 개발하게 되었다. 확장한 서비스이다 보니, 새롭게 개발하는 과정에서 topic 의 이름이 중복되는 문제가 발생하였다.  
Legacy 시스템인 A 는 언젠간 폐쇄를 하겠지만 유저의 마이그레이션부터 해서 일정이 꽤나 걸릴 예정이라  
두개의 서비스를 어느 기간동안은 동시에 운영해야하는 상황이였다.


문제를 해결하기 위한 방법중 

1. 중복되는 부분을 피해 토픽 명 생성. 
2. header 를 통해 서버 별 분기 처리. 
3. 스키마 레지스트리 도입.

> 2 번의 경우, 두개의 시스템의 메시지를 모두 컨슘해야하고, 어떤 서비스에서 발생한 메세지인지 명확하게 추적하기 어렵다는 문제가 존재.  
> 3 번의 경우, 앞단의 Proxy 서버를 통해 스키마의 유효성검사를 하고 있었기 때문에 중복되는 문제와 처음 써보는 기술이기 때문에 복잡성 존재.


이러한 이유를 기반으로 중복되는 부분을 피해 토픽명을 생성하기로 하였다.  

토픽명을 새롭게 생성하는 과정에서 앞으로 이러한 문제가 발생하지 않기 위한 토픽 컨벤션을 정하였다.

> <환경><도메인><서비스 혹은 기능><이벤트><버전>  
> dev.lecture.round.ended.v1
